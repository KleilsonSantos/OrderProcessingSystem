# ğŸš€ CI/CD Workflow para build de projeto Java com Maven + PostgreSQL
# ğŸ“˜ DocumentaÃ§Ã£o oficial: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

name: Java CI with Maven ğŸ§‘â€ğŸ’»

on:
  push:
    branches: [ "main" ] # ğŸ“¤ Dispara ao fazer push na branch principal
  pull_request:
    branches: [ "main" ] # ğŸ”„ Dispara ao abrir PRs para a branch principal

jobs:
  build:
    runs-on: ubuntu-latest # ğŸ–¥ï¸ Utiliza a Ãºltima versÃ£o estÃ¡vel do Ubuntu

    services:
      db:
        image: postgres:latest # ğŸ˜ Sobe um container com PostgreSQL
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres # ğŸ” ConfiguraÃ§Ã£o das credenciais
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: orderdb # ğŸ—ƒï¸ Banco usado nos testes

    steps:
    - name: ğŸ“¦ Clonando o repositÃ³rio...
      uses: actions/checkout@v4
    - run: echo "âœ… RepositÃ³rio clonado com sucesso! ğŸ‰"

    - name: â˜• Configurando Java 17...
      uses: actions/setup-java@v4
      with:
        java-version: '17' # ğŸ¯ VersÃ£o alvo do JDK
        distribution: 'temurin'
        cache: maven # ğŸ—ƒï¸ Cache para acelerar builds futuros
    - run: echo "âœ… Java 17 configurado! ğŸ”§"

    #- name: ğŸŒ©ï¸ Analisando qualidade com SonarCloud...
    #  uses: SonarSource/sonarcloud-github-action@v2
    #  with:
    #    projectBaseDir: .
    #    organization: order-system
    #    projectKey: order-system
    #- run: echo "âœ… AnÃ¡lise com SonarCloud concluÃ­da! ğŸ“Š"

    #- name: ğŸ“ Rodando Checkstyle...
    #  run: mvn checkstyle:check
    #- run: echo "âœ… Estilo de cÃ³digo verificado! âœ”ï¸"

    #- name: ğŸ› Rodando SpotBugs...
    #  run: mvn spotbugs:check
    #- run: echo "âœ… AnÃ¡lise de bugs finalizada! ğŸ•µï¸"

    - name: ğŸ§ª Executando testes unitÃ¡rios...
      env:
        SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/orderdb # ğŸ”— ConfiguraÃ§Ã£o DB
        SPRING_DATASOURCE_USERNAME: postgres
        SPRING_DATASOURCE_PASSWORD: postgres
      run: mvn test
    - run: echo "âœ… Testes executados com sucesso! ğŸ§ªâœ…"

    - name: ğŸ“Š Gerando relatÃ³rio de cobertura (JaCoCo)...
      run: mvn jacoco:report
    - run: echo "âœ… RelatÃ³rio de cobertura gerado! ğŸ“ˆ"

    - name: â¬†ï¸ Enviando relatÃ³rio como artefato...
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report # ğŸ—‚ï¸ Nome do artefato
        path: target/site/jacoco/index.html # ğŸ“ Caminho do HTML
    - run: echo "âœ… RelatÃ³rio enviado com sucesso! ğŸ“¤"

    #- name: ğŸ” Verificando vulnerabilidades de dependÃªncias...
    #  run: mvn org.owasp:dependency-check-maven:check
    #- run: echo "âœ… VerificaÃ§Ã£o de vulnerabilidades finalizada! ğŸ”’"

    - name: ğŸ—ï¸ Compilando projeto com Maven...
      run: mvn -B package --file pom.xml
    - run: echo "âœ… Projeto compilado com sucesso! ğŸš€"

    # ğŸ“ˆ AtualizaÃ§Ã£o opcional do grÃ¡fico de dependÃªncias
    #- name: Atualizando grÃ¡fico de dependÃªncias...
    #  uses: advanced-security/maven-dependency-submission-action@571e99aab1055c2e71a1e2309b9691de18d6b7d6
    #- run: echo "âœ… GrÃ¡fico de dependÃªncias atualizado! ğŸ“Š"
